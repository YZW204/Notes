## 数据链路层

> 把实现通信协议的硬件和软件加到链路上，就构成了数据链路层
>
>  
>
> 以帧为单位传输和处理数据

## 1. 封装成帧

> 数据链路层为网络层的数据添加**帧首**和**帧尾**使之成为帧的过程

<img src="https://s2.loli.net/2022/03/29/obhisnpjWaZ1fQX.png" alt="image-20210128165621909" style="zoom: 67%;" />

**透明传输**：不会修改上层传输的数据，数据会完整的传输到其他层

- 字节填充

  > 使用帧头帧尾来区分帧（如果数据和头尾一样用转义符号来防止）

- 比特填充

  > 每5个连续1插入0，避免混淆

## 2. 差错检测

> 比特传输过程中会出现差错，差错总数称为：**误码率BER**

### 1.奇偶校验

> 奇数个 1 ，还是偶数个 1来进行校验

### 2. 循环冗余校验CRC

1. 约定生成一个多项式`G(X)`，数据添加该多项式最高次数个0（比如$x^3$就需要添加3个零）

<img src="https://s2.loli.net/2022/03/29/Cfli6t9x7HBIdFA.png" alt="image-20210129164100468" style="zoom:50%;" />

2. **发送方**把数据 %（多项式系数构成）除数 的余数添加到数据一起传输

   > 取余过程中各位用异或进行处理

3. **接收方**把数据（包括冗余数） %  (多项式系数构成）除数，  

<img src="https://s2.loli.net/2022/03/29/ubpQrqoEYv3AHNI.png" alt="image-20210129164028312" style="zoom:50%;" />

除法过程：

<img src="https://s2.loli.net/2022/03/29/FuQlLkHaW9Z8Dm5.png" alt="image-20210129164909285" style="zoom:50%;" />

- **检错码**只能检错，CRC检错能力很高，较少的误判率，易于实现。
- 如果发现出错，计算机网络采用**重传的方式来纠正**（简单粗暴）

## 3. 可靠传输

> 不可靠传输：仅仅丢弃有误码的帧，其他什么也不做
>
> 可靠传输：通过其他方法保证发送端和接收端的接收的内容一致

- **有线链路**的误码率较低，一般不用可靠传输；**无线链路**误码率较高，必须要求使用可靠传输
- 传输差错还包括运输层中的分组丢失，失序，重复

### 1. 停止-等待协议SW

> 没有收到确认信息就等待

发送-->接收-->确认（成功/失败）

1. 避免重复接收：序号区分
2. 避免死锁：计时器
3. 避免接收双方序号出现冲突：双方都有各自的序号

<img src="https://s2.loli.net/2022/03/29/XrjgpeWnytImd4N.png" alt="image-20210130155951376" style="zoom:50%;" />

<img src="https://s2.loli.net/2022/03/29/cI4nbv7gSTZy98a.png" alt="image-20210130160600416" style="zoom:50%;" />

> $T_A$通常很小

### 2. 回退N帧协议GBN

> **只有一个接收窗口，一个误码，全部重传**
>
> 为了减少传播时延，同时发送多个分组（发送窗口），接收按顺序接收（1的大小的接收窗口）
>
> 发送窗口大小是不能大于分组长度的一半，否则不能区分是**重传**还是**正常接收**

<img src="https://s2.loli.net/2022/03/29/OhsZBx3FP5wKJzn.png" alt="image-20210130163316987" style="zoom:50%;" />

<img src="https://s2.loli.net/2022/03/29/hkRGJaV2pbSvmq9.png" alt="image-20210130162603910" style="zoom:50%;" />

### 3. 选择重传协议SR

> 为了避免第一个顺序误码而导致接收的所有分组失效，所以接收窗口有多个

<img src="https://s2.loli.net/2022/03/29/FSRLW4iQ9JO3b2M.png" alt="image-20210130165642553" style="zoom:50%;" />

<img src="https://s2.loli.net/2022/03/29/cy5t3RPkrVqIKCS.png" alt="image-20210130165330624" style="zoom:50%;" />

## 4. PPP协议

> 数据链路层协议，用于规定帧格式

<img src="https://s2.loli.net/2022/03/29/WKzUXiq9gGNZfom.png" alt="image-20210201201917595" style="zoom:50%;" />

### 透明传输

1. 字节填充法

> 帧的首位都是7E，所以7E都需要转义一下

- 和帧首尾一样的7E 前面插入 7D（转义字符）+（7E-20）==7D5E
- 对于本来就有的7D（转义字符），7D+(7D-20)==7D5E
- 对于`Ascall`控制符，如03 ： 7D+03+20==7D23

<img src="https://s2.loli.net/2022/03/29/Et78yagOBYbvNGW.png" alt="image-20210201203628640" style="zoom:50%;" />

2. 比特填充法
   + **发送方**：对帧的数据部分进行扫描(一般由硬件实现)。只要**发现5个连续的比特1，则立即填充1个比特0**
   + **接收方**：对帧的数据部分进行扫描(一般由硬件实现)。只要**发现5个连续的比特1，就把其后的1个比特0删除**

> 接收方都是反规则进行还原即可
>
> 差错检测：
>
> 采用的时`crc`检验

## 5. 媒体接入层

> 多个发送端和一个接收端对于共享一条线路的问题，媒体既接入控制MAC`(`Medium Access Control`)`

概念：**复用**：一条线路同时传输多路用户

<img src="https://s2.loli.net/2022/03/29/sx49U8GWoMyzXvu.png" alt="image-20210322202556354" style="zoom:50%;" />

### 1. 频分复用FDM[Frequency-division multiplexing]

> 复用器将资源划分成多个子频带，分用器在组合

<img src="https://s2.loli.net/2022/03/29/A9EZ7R4zBVomyeU.png" alt="image-20210322204101543" style="zoom:50%;" />

### 2. 时分复用TDM[Time-division multiplexing]

> 按时间分配固定的资源

<img src="https://s2.loli.net/2022/03/29/SALTRcrwCotmn4D.png" alt="image-20210322210341303" style="zoom:50%;" />

### 3. 波分复用WDM

> 通过光调制到不同的波长，得以在一根光纤中传输

<img src="https://s2.loli.net/2022/03/29/lgosMGk85SI3rLf.png" alt="image-20210322211112508" style="zoom:50%;" />

### 4. 码分复用CDMA[Code Division Multiple Access]

> 各用户使用不同的码型来避免干扰
>
> **码片**：在CDMA中由每个比特时间再划分为 m 个短的间隔

<img src="https://s2.loli.net/2022/03/29/9ZTg3HwV78uRjML.png" alt="image-20210322213435188" style="zoom:50%;" />

**码片的原则：**

1. 各个码片必须各不相同，常采用伪随机码序列

2. 必须相互正交（规格化内积为 0 ）

   $S*T\equiv0$  未传播

   $S*\overline T\equiv0$ 未传播

   $S*S\equiv1$ 传播 1

   $S*\overline S\equiv-1$ 传播 0

<img src="https://s2.loli.net/2022/03/29/caRbiq3C8J9gDZj.png" alt="image-20210322214653701" style="zoom:50%;" />

### 复用与多址

**复用**：

> 将频带资源划分成**独立的子信道**

**多址**：

> 动态**暂时**分配信道给用户（如移动通信）

### 动态接入控制

 **1. 随机接入**

> 多个主机连接到一根总线上要避免碰撞

###  载波监听多址接入/碰撞检测（CSMA/CD)【有线网络】

> **帧间最小间隔**：使接收方能检测出一个帧的结束

<img src="https://s2.loli.net/2022/03/29/cZyMakCbJ3VBiH1.png" alt="image-20210323103954584" style="zoom:50%;" />

<img src="https://s2.loli.net/2022/03/29/RWnthbov46kScO5.png" alt="image-20210323104543644" style="zoom:50%;" />

<img src="https://s2.loli.net/2022/03/29/jsTOyVhC6bJUEAL.png" alt="image-20210323105720561" style="zoom:50%;" />

> 相关字母的解释：
>
> $\delta$ 表示的是 A只剩下 $\delta$ 的时间走完，
>
> $\tau - \frac{\delta}{2}$ 是因为在此时A 和 D 共同走完剩下的 $\delta$ 时间
>
> $\frac{\delta}{2}$是D在$\tau-\delta$这个时间点出发，速度相同，所以碰撞时间为$\tau-\frac{\delta}{2}$

3. 一些**性质**：

- 主机最多经过 $2\tau$ 的时间就检测到是否遭受了碰撞，因此$2\tau$ 称为：**争用期、碰撞窗口期** (相当于一个来回都没有碰撞消息，所以是接收了)
- 主机越多，总线距离越长，往返时延越大，发生碰撞的可能性就越大

4. **最小帧长**：

   > **发送的时间就是争用期**
   >
   > **64字节**，不足则填充，
   >
   > 保证了检测到是否发生过碰撞

5. **最大帧长：**

   > 避免其他主机得不到资源

<img src="https://s2.loli.net/2022/03/29/g1PvAn7LechW3sR.png" alt="image-20210323194506744" style="zoom:50%;" />

6. **退避算法**

   > 当帧发送碰撞后会停止发送，隔一段时间后再次发送，而具体隔多少时间再发送需要根据退避算法得出

<img src="https://s2.loli.net/2022/03/29/8H6mXgsEKYrzupa.png" alt="image-20210323195647316" style="zoom:50%;" />

7 . **极限信道利用率：**

> 最理想的条件下（无碰撞、有空闲就发送）
>
> 每帧的发送时延为$T_0$，传播时延为$\tau$，占用信道的时间为$T_0+\tau$

$$
极限信道利用率S_{max}=\dfrac{T_0}{T_0+\tau}=\dfrac{1}{1+\dfrac{\tau}{T_0}}\\
为了令S_{max}尽量大，所以应该让\dfrac{\tau}{T_0}尽量小\\
即\tau尽量小(以太网端到端距离收到限制)或T_0尽量大(以太网帧尽量长)
$$

### 载波监听多点接入/碰撞避免（SCMA/CA）【无线网络】

- **可以使用载波监听多址接入CSMA**，如果有其他站发送帧，则推迟发送避免碰撞

- **无法使用碰撞检测CD：**

  - 信号强度小，对硬件要求高
  - 可能存在**隐蔽站**，即不饿能覆盖所有的范围

  <img src="https://s2.loli.net/2022/03/29/yZCBh2xXsqTpK9e.png" alt="image-20210323205537045" style="zoom:50%;" />

**1. 帧间间隔 IFS **

> 必须检测到信道空闲一段时间才能发送帧，这个时间间隔称为 IFS

**2. 帧间间隔的长短取决于该站点要发送的帧的类型**

- 高级帧等待时间较短，会优先获得发送权
- **短帧间间隔SIFS($28\mu m$)**。最短的帧间间隔，用分割一次对话的各帧，站点在此转换收发方式
- **DCF 帧间间隔 DIFS（$128 \mu s$）**.DCF 中用来发送数据帧和管理帧

<img src="https://s2.loli.net/2022/03/29/nWqFT9OjSiL5w2l.png" alt="image-20210324090833801" style="zoom:50%;" />

**图解：**

**1. 等待DIFS的意义**

> 给高优先级的帧让位，如果没有帧发送，则是真的空闲

**2. 等待SIFS 的意义**

> 用来使站点转变成发送状态

**3. 回退了时间后，再次等待随机时间的意义**

> 错峰发送，同时避免再次碰撞

### 5.  **退避算法**

> 当多个站点发送冲突时，各个站点需要回退一段随机时间再操作

1. 需要**使用退避算法**的情况

   1. 发送数据帧时**信道处于忙状态**

   2. 进行**重传**

   3. **成功发送后要再发送下一个帧**（避免连续占用）

2. **过程**：

   1. 退避计时器设置一个随机的退避时间
   2. 当信道**再次处于忙状态时，冻结退避计时器，等待信道空闲时才继续倒计时**

<img src="https://s2.loli.net/2022/03/29/gIkTD49wAoXMc7L.png" alt="image-20210324092919347" style="zoom:50%;" />

### 6. 信道预约

> 通过小数据进行预约可以降低碰撞

**过程**

1. ==源站==先发送短的控制帧（**请求发生RTS**）
2. **目的站**收到`RTS`+空闲，则返回一个响应控制帧（**允许发送CTS**）
3. ==源站==收到`CTS`后，等待`SIFS`时间发送数据
   1. 发生碰撞--> 源站收不到CTS--> 回退算法重传RTS
   2. 由于用短帧，所以**碰撞概率低、重传开销低、本身发送开销低**
4. **目的站**收到数据帧，等待SIFS后，向源站发送ACK确认

<img src="https://s2.loli.net/2022/03/29/kOFUaXqdo3E79Wi.png" alt="image-20210324094639706" style="zoom:50%;" />

### 7.虚拟载波监听

> RTS帧和CTS帧以及数据帧需要的持续时间称为**虚拟载波监听**

- 源站只需要监听到**目的站的RTS、CTS帧的其中一个，就能避免碰撞**
- 如下图，`A`与`C`虽然互相覆盖不到，但是**C可收到B发出的关于A的CTS帧，从而得知A需要占用信道的时间**。在这段时间里，`C`不发送数据，从而解决隐蔽站带来的碰撞问题

<img src="https://s2.loli.net/2022/03/29/xlqcFGWBMnONiau.png" alt="image-20210324100904465" style="zoom: 33%;"/>

## 6. MAC 地址、IP 地址和 ARP 协议

### 1. MAC 地址

> 网络中物理设备的唯一标识，用来接收网线的数据流

1. **用来表示每个物理主机的唯一标识**，即一个数据链路层地址
2. 因为发送的帧携带识别发送主机和接受主机的地址，这类地址是用于**媒体接入控制 MAC **,因此被称为 MAC地址
   - 一般被固化在网卡的电可擦可编程只读存储器，因此称为==硬件地址==有时也叫==物理地址==
3. 用户主机包含两个网络适配器：有线局域网适配器（有线网卡）和无线局域网适配器（无线网卡），每个适配器都有一个全球唯一的 MAC 地址。交换机和路由器往往拥有更多的网络接口，所以有更多的 MAC 地址。综上所述，严格来说，==MAC地址是对网络上各接口的唯一标识，而不是对网络上各设备的唯一标识==

**1. MAC地址格式：**

<img src="https://s2.loli.net/2022/03/29/qn8w3AWoycvLD1H.png" alt="image-20210324113202609" style="zoom:50%;" />

<img src="https://s2.loli.net/2022/03/29/z7CjfwV4rxQsFUS.png" alt="image-20210324113544917" style="zoom:50%;" />

**2. 单播地址、多播地址与广播地址**

- **单播地址**：唯一一个准确的地址会与他匹配
- **多播地址：**MAC地址的第一字节后最后一个比特位1时，是多播地址，此时位与自己的**多播地址列表进行匹配，判断是否接收**

### 2. IP 地址

> IP 地址是 TCP/IP体系结构的网际层所使用的地址

**1. IP 地址是因特网上的主机和路由器所使用的地址，由两部分信息构成**

- **网络编码：**区别因特网上的网络
- **主机编号：**区别同一网络上的不同主机

> MAC 地址不具备区分不同网络的功能，而 IP地址可以通过网络号做到

**2. 数据包转发过程中IP地址与 MAC地址变换情况：**

> 需要一个物理地址来“路由”，还需要一个网络地址来确认目的主机

<img src="https://s2.loli.net/2022/03/29/VeP5o1BGfOQiH8F.png" alt="image-20210324155136245" style="zoom:50%;" />

- **源 IP 和目的 IP 始终不变**
- **源 MAC 和目的 MAC随路由而改变**
- 路由器上有**路由表，记录了 ip 对应要走的路由器**，路由靠着目的IP在各个路由中跳转                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              

### 3. ARP 协议

> 通过 IP 地址解析获取到设备的 MAC 地址

- 主机中有一个 **ARP 高速缓存表，记录有IP地址与 MAC地址的对应关系**
- 如果找不到，则==发送广播==（**封装在 MAC帧中**，目的地址位广播地址 `FF-FF-FF-FF-FF-FF`）:

  - 我的 ip 和 mac 地址是，目的主机的mac地址是多少
  - 如果主机发现自己不是目的主机则不理会，反之，存储到自己的告诉缓存中，并发送 ARP 相应报文（包含自己的MAC 地址）
- **高速缓存有静态和动态：**

  - 动态是广播获取的，声明周期2分钟
  - 静态是手工设置的，生命周期由操作系统设置
  
- **ARP只能在一段链路或一个网络上使用**

## 7.集线器与交换机

> 对接收到的信号进行再生整形放大，以扩大网络的传输距离，同时把所有节点集中在以它为中心的节点上

### 1. 集线器

- **逻辑上还是一个总线网**，共享总线资源，使用`CSMA/CD`协议
- 只会**简单地转发比特**（碰撞由网卡检测）
- **一点管理能力**，如断开网卡
- **半双工**，不会同时收发

### 2. 交换机

> **负责转发信号**，可以为接入交换机的节点提供独享的电信号通路

- **多个接口**，都可以与主机或以太网相连，**全双工**
- **并行性，能连通多对接口，同时通信。**无碰撞（不适用CSMA/CD协议）
- **通过帧交换表查找对应的 MAC地址的接口号，然后通过接口转发帧**
- 帧的两种转发方式
  - 存储转发
  - 直接交换：基于硬件
- 交换机的每个接口时一个独立的碰撞域

**交换机自学习和转发帧**

<img src="https://s2.loli.net/2022/03/29/AvK38IofsrLUwDR.png" alt="image-20210324200547219" style="zoom:50%;" />

+ 初始交换机`1`和`2`的`MAC`地址表都为空
+ 此时有以下任务：①`A-->B` ②`B-->A` 

> 不会概括了，只能照搬全过程的细节

1. `A`发送给`B`的数据通过端口`1`进入交换机，因此交换机先将`MAC地址A 接口1`==**(表示如果要去MAC地址A，可以走接口1)**==记录到`MAC`表中，同时扫描`MAC`表查看是否有`MAC地址B`对应的接口，发现没有。因此将这个帧从**除来源外的所有端口**发送出去【泛洪】。

   + 交换机`1`的端口`2`发送此帧到主机`C`，主机`C`对比`MAC`地址后发现不是给自己的帧，因此丢弃
   + 交换机`1`的`3`端口发送此帧到主机`B`，主机`B`对比`MAC`地址后发现是给自己的帧，因此收下该帧，交付给高层【注意：此时交换机`MAC`地址表并没有学习新的条目】
   + 交换机`1`的`4`端口发送此帧到交换机`2`的端口`2`，交换机`2`首先将`MAC地址A 接口2`记录到`MAC`地址表中，接着扫描`MAC`表，发现没有找到`MAC地址B`对应的接口，因此将这个帧从除来源外的所有端口发送出去【泛洪】。
   + 同理，接口`1`，`3`，`4`发送出去给主机后经过比对发现不是自己的帧，因此丢弃

2. `B-->A`时，交换机`1`的`MAC`地址表已经有了`MAC地址A 接口1`这个条目

   + `B`发送给`A`的帧从接口`3`进入交换机，交换机首先将`MAC地址B 接口3`记录到`MAC`地址表中，接着查询`MAC`地址表是否有`MAC地址A`对应的接口，发现接口`1`对应的就是`MAC`地址`A`，因此从接口`1`转发出去
   + 帧通过接口`1`到达主机`A`，主机`A`经过比对后发现这是自己的帧，因此将其接收交付给高层

3. 此时若有一个与`A`连接在同一总线上的主机`G`向`A`发送帧，过程如何？

   <img src="https://s2.loli.net/2022/03/29/h6qpIDymOVULufP.png" alt="image-20210324202645078" style="zoom:33%;" />

   + `G`向`A`发送帧时，由于`A`与`G`处在同一总线上，因此`G`发送的帧会直接传送到`A`处，`A`进行比对发现这是发送给自己的数据，因此将数据接收
   + 同时数据会跑向交换机`1`的端口`1`，所以交换机`1`会将`MAC地址G 接口1`记录到`MAC`表中，同时扫描`MAC`地址表看看是否有`MAC地址A`对应的接口，发现接口`1`就是。但是刚刚学习到的`MAC地址G`也是来自接口`1`，因此交换机知道接口`1`是来源，没有必要将数据再从这个接口转发出去。

**MAC地址表中的记录都有自己的有效时间，到期自动删除**（MAC地址与交换机对应关系并时不时永久性的）

### 3. STP生成树协议

> 增加冗余链路来提高网络可靠性同时避免环路

如下图，`A`与`B`之间的链路发送故障后，`H1`便无法与`H2`和`H3`进行通信

<img src="https://s2.loli.net/2022/03/29/OgzHb1MUtITWu2w.png" alt="image-20210325085836691" style="zoom: 33%;" />

**在B 和 C 之间多拉一条链路**，这样可以增加抗故障性，但是会有广播风暴

<img src="https://s2.loli.net/2022/03/29/eJgnW4AYT6aO8k3.png" alt="image-20210325090406814" style="zoom: 33%;" />

- 帧会在交换机中不停转发，形成问题：
  - **广播风暴**
    - 消耗大量网络资源，无法正常转发其他数据帧
  - **主机收到重复的广播帧**
    - 大量消耗主机资源
  - **交换机的帧交换表震荡**
    - 内容不断更新 

**生成树原理**

- 构建一个拓扑结构（无环）
- **拓扑结构发生变化时，会重新生成树**

### 4. VLAN虚拟局域网

> 一种将局域网内的设备划分成与物理位置无关的逻辑组技术，每个VLAN就是一个独立的广播域

**为什么需要VLAN**

> 1. 避免广播风暴
> 2. 便于管理和维护
> 3. 增大安全性

缺省VLAN ID

> 华为交换机叫 PVID，每个端口都有，默认情况下都为 1

**端口上接收时总希望能够打上标签，发送出去时，总希望能够去除标签**

**1. Access 端口**

> 一般用于终端设备与交换机之间
>
> **交换机与路由器也用 Access接口**，路由器默认是当作终端

- 交换机初始端口是Access
- 端口只能属于**一个 VLAN**
- Access 端口的**PVID 与端口所属 VLAN的ID相同**
- **接收：接收“未打标签” 的MAC帧，然后打上本地端口的 PVID的值（标签，VID）**
- **发送：如果端口和标签一样，则“去标签”转发**

**2. Trunk 端口**

> 用于**交换机与交换机、交换机与路由**

- 可以属于**多个VLAN**
- 可以设置PVID值
- **发送：VID和PVID相等，则“去标签”转发；不相等，直接转发**
- **接收：“未打标签”，进行“打标签”；否则直接接收**

**3. VLAN 实现机制**

<img src="https://s2.loli.net/2022/03/21/gOt9BJI5yTU1qr2.png" alt="image-20210325121915329" style="zoom:50%;" />

- **最后12 bit是 VLAN的标识符 VID**
  - 取值`0~4095`
  - 有效范围`1~4094`
- 802.1Q帧由交换机处理，不由主机处理
  - 交换机接收**普通帧时，会插入4字节VLAN转化未802.1Q，此过程称为“打标签”**
  - 当交换机转发802.1Q帧时，**==可能==，会删除VLAN转变未普通帧，称为“去标签**

