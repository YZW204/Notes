## 运输层

> **物理层、数据链路层和网络层**实现了主机通过异构网络互联起来所面临的问题，实现了**主机到主机的通信**
>
> **真正通信的是两端主机的进程**
>
> 因此运输层协议又称端到端协议，**为运行在不同主机上的应用进程提供直接的通信服务**

## 1. 端口号

> 为了使不同操作系统的应用能进行通信，**必须使用统一的方法对应用进程进行标识，这就是端口号**

- **PID在各个系统是不同格式，所以不能用其来表示应用进程**

- **端口号只有本地意义**，只是为了标识不同的应用进程
- 端口号用16比特表示，取值为0~65535
  + **熟知端口号：0~1023**，`IANA`把这些端口号指派给了`TCP/IP`体系中最重要的一些应用协议
  + **登记端口号：1024~49151**，为没有熟知端口号的应用程序使用。使用这类端口号必须在`IANA`按照规定的手续登记，以防止重复。如`Microsoft RDP`微软远程桌面使用的端口是`3389`
  + **短暂端口号：49152~65535**，留给客户进程选择暂时使用。当服务器进程收到客户进程的报文时，就知道了客户进程所使用的的动态端口号。**通信结束后，这个端口号可供其他客户进程以后使用**

<img src="https://s2.loli.net/2022/03/29/rVK2oCIJ9nScLlN.png" alt="image-20210407092941219" style="zoom:50%;" />

## 2. 复用

- 发送方发送不同的应用报文使用不同的协议称为**复用**，在运输层使用UDP协议进行封装，这是UDP复用；若用TCP封装则称TCP复用 
- 网络层需要使用**IP协议封装成IP数据报，这是IP复用**
- 将**IP数据报封装的协议数据单元上交给运输层的过程叫IP分用**，交付应用层的叫做**UDP分用或TCP分用**

## 3， 用户数据报协议UDP

- **无连接，随时发送报文**，支持单播，多播和广播

- 收到应用层报文后**直接为报文添加UDP首部**进行发送

- 首部仅8字节

  <img src="https://s2.loli.net/2022/03/29/Z4dbhMaEHJBpXKl.png" alt="image-20210407094446337" style="zoom:50%;" />

## 4. 传输控制协议TCP

- **面向连接，需要“三报文握手”，“四报文挥手”**，因此只支持单播
- **面向字节流、可靠传输**
- TCP报文首部最小20字节，最大60字节
- <img src="https://s2.loli.net/2022/03/29/HwtMzCyxukhmE3Z.png" alt="image-20210407095549799" style="zoom: 67%;" />

### 1. 流量控制

> 如果发送方发送得过快，接受方会可能来不及接收，造成数据丢失
>
> **流量控制就是避免这种情况发生**

**利用滑动窗口实现流量控制**

- 发送随接收窗口变化（通过确认报文告知发送方）
- 发送方需要等到确认报文才会滑动窗口继续发送，如果没有收到，则**超时重传**

**接收窗口调为0后，会发送确认报文（带计时器）**，发送窗口也会发送一个**窗口探测报文（带计时器）**

### 2. 拥塞控制

> **网络中某一资源的需求超过了该资源所能提供的可用部分**，网络性能就变坏，这就叫**拥塞**

**1. 慢开始和拥塞避免**

- 发送方维护**拥塞窗口cwnd**变量，其取决于网络的拥塞程度，动态变化
  - 维护原则：**只要不拥塞，就增大；反之，就减少**
  - **拥塞依据：**没有出现超时重传
- 发送窗口将拥塞窗口作为发送窗口swnd
- 维护一个**慢开始门限ssthresh**状态变量
  + 当`cwnd < ssthresh`时，使用慢开始算法
  + 当`cwnd > ssthresh`时，停止使用慢开始算法而改用拥塞避免算法
  + 当`cwnd = ssthresh`时，既可使用慢开始算法，也可以使用拥塞避免算法

**慢开始**

> 从1开始，根据应答报文来扩大拥塞窗口，应答多少，增多少

**拥塞避免**

> **每次扩大1*，如果出现超时重传，则判断拥塞，将拥塞窗口初始化为1，慢开始门限为一半**

<img src="https://s2.loli.net/2022/03/29/hDPsLE3JnlBipOA.png" alt="image-20210407110048100" style="zoom:50%;" />

**2. 快重传和快恢复**

**快重传**

> **对方尽快进行重传**，不等超时重传计时器

- 要求接收方**立即发送确认**
- 收到了**失序的报文**也要发出重复确认
- **发送方收到3个连续的重复确认，就将相应的报文立即重传（不等计时器）**
> 对丢失的报文，发送方不会出现超时重传，也不会误认为出现了拥塞，可以提高吞入量

<img src="https://s2.loli.net/2022/03/29/1b7N9uePnxyokd5.png" alt="image-20210407113656006" style="zoom:50%;" />

发送方一旦收到`3`个重复确认，就知道现在只是丢失了个别报文段。也是不启动慢开始算法，而执行**快恢复算法**

+ 发送方**将慢开始门限ssthresh值和拥塞窗口cwnd值调整为当前窗口的一半，开始执行拥塞避免算法**
+ 也有的快恢复实现是把快恢复开始时的拥塞窗口`cwnd`值再增大一些，即等于新的`ssthresh+3`
  + 既然发送方收到`3`个重复的确认，就表明有`3`个数据报文段已经离开了网络
  + 这三个报文段不再消耗网络资源而是停留在接收方的接收缓存中
  + 可见现在网络中不是堆积了报文段而是减少了`3`个报文段。因此可以适当把拥塞窗口扩大些

<img src="https://s2.loli.net/2022/03/29/BR9zpjXI7kEDfd6.png" alt="image-20210407142013666" style="zoom:50%;" />

**3. 超时重传时间（RTO）选择**

> 超时重传时间应该设为略大于往返时间。但是各区域的速率可能不一致，因此将超时重传时间设置为一个固定值是不行的

利用每次测量得到的RTT（往返时间）计算**加权平均往返时间**，**超时重传时间RTO应略大于RTT**

<img src="https://s2.loli.net/2022/03/29/IlKhjM3FcwAvq6H.png" alt="image-20210407184344967" style="zoom: 33%;" />

**往返时间测量问题**

<img src="https://s2.loli.net/2022/03/29/4yMUP5ltq3eO8QN.png" alt="image-20210407185821019" style="zoom: 33%;" />

**解决超时重传问题**

> 1. **出现超时重传，就不进行计算**
>
>    - 缺点：
>
>      如果时延突然增大并保持，那么就会出现死锁
>
> 2. **出现超时重传，就把超时重传时间RTO增大2倍**

**可靠传输**

<img src="https://s2.loli.net/2022/03/29/8wVpqWGMRQrk6Fu.png" alt="image-20210408092748777" style="zoom:50%;" />

## 5. 三次握手和四次挥手

> TCP的运输层链接管理就是使运输层连接的建立和释放都能正常地进行

1. **三次握手**

- SYN=1的报文段不能携带数据，但会消耗一个序列号
- ACK=1代表这是普通确认报文段，**ack=x+1表示这是对报文段序列号seq=x的确认**

<img src="https://s2.loli.net/2022/03/29/aXUOEKi3TgrQjoC.png" alt="image-20210408094126188" style="zoom:50%;" />



2. **四次挥手**

<img src="https://s2.loli.net/2022/03/29/BoSXaAg4jTWk3st.png" alt="image-20210408095455939" style="zoom:50%;" />

- 客户端发起关闭请求，一去一回后进入半关闭状态**客户端不再发送数据，服务端可能还会发**

- **服务器将自己剩余的数据发送完后也发送一个关闭请求**，客户端给予回应后服务器关闭，，客户端要等待一段时间后才能完全关闭**（防止发给服务器的确认报文丢失）**

3. **保活计时器**

   > 避免其中一台机器因为**突发故障**导致链接不能正常关闭

   <img src="https://s2.loli.net/2022/03/29/A2z7nb4o8SwRuVL.png" alt="image-20210408095936148" style="zoom:50%;" />

4. **TCP首部格式**

   <img src="https://s2.loli.net/2022/03/29/DIiPBuM52NhKxaS.png" alt="image-20210408100356000" style="zoom:50%;" />

1. **源端口**：16比特，写入源端口号，标识**发送的TCP报文段的应用进程**

2. **目的端口：**16比特，写入目的端口号，标识**接收该TCP报文段的应用进程**

3. **序号：**32比特，取值[$0~2^{32}-1$]，序号会自动取模回来（即为0），**用来指出本TCP、报文段数据载荷的第一个字节的序号**

4. **确认标志位ACK：**1比特。1有效，0无效

5. **确认号：**32比特，取值[$0~2^{32}-1$]，序号会自动取模回来（即为0），**表明当前号（比如n）之前的数据都接收，期望接收序号n开始的数据**

6. **数据偏移：**4比特，**4字节为单位**（和IP数据报一样）

   用来表示**首部长度**，$(0101)_2$表示首部长度为20字节

7. **保留字段：**6比特，还未用（全0）

8. **窗口：**16比特，以字节为单位。**发送本报文段一方的接收窗口**

   **以接收方的接收能力来控制发送方的发送能力**，简称流量控制

9. **检验和：**16比特，检测整个报文段

10. **同步标志位SYN：**1比特，在TCP连接时建立是用来同步序号

11. **终止标志位FIN：**1比特，在TCP释放时用来表示

12. **复位标志位RST：**1比特，用来复位TCP连接

    - RST=1，表示连接出现异常，必须释放连接，重新建立连接
    - RST=1，也可以用来拒绝一个非法的报文段或拒绝打开一个TCP连接

13. **推送标志位PUSH：**1比特，1有效，**表示尽快上交应用进程**，不会等到接收缓存填满

14. **紧急指针：**16比特，以字节为单位，用来知名紧急数据的长度

    紧急数据**会插队到发送缓存的最前面**

15. **选项：**增加选项可以增加TCP的功能

    - **最大报文段长度MSS选项：**TCP报文段数据载荷部分的最大长度
    - **窗口扩大选项：**扩大窗口（提高吞吐率）
    - **时间戳选项：*
      - 计算往返时间RTT
      - 用于处理序号超范围的情况，又称防止序号绕回PAWS
    - **选择确认选项：**实现选择确认功能

16. **填充：**由于选项长度可变，**使用填充来保证报文段首部能被4整除**

