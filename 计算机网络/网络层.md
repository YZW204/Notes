## 网络层

> 实现网络互连，进而实现数据包在各网络间的传输

## 1.面向连接的虚电路服务

- 需要可靠的通信网络，建立网络层的连接**虚电路**
- 双方沿着**已建立的虚电路发送分组**
- 分组只需要携带虚电路的编号
- 如果使用可靠传输协议，就可使发送的分组最终正确到达接收方
- 通信结束释放之前所建立的虚电路

## 2. 无连接的数据报服务

- 可靠通信**由用户主机来保证**
- **不需要建立网络层连接，每个分组可以走不同路径**
- 必须携带目的主机完整地址
- **会产生误码、丢失、重复和失序的问题**
- 网络本身不提供端到端的可靠传输服务，因此，路由器的构造做得比较简单，价格低廉
- **将复杂的网络处理功能置于用户主机和主机的运输层**，而将相对简单的分组交付功能置于因特网中

## 3. IPv4地址

> `IPv4`地址就是因特网上**每一台主机（或路由器）的每个接口**分配的全世界**唯一的32比特标识符**

**分类编址**

<img src="https://s2.loli.net/2022/03/29/liMgrVT1UBoqRYb.png" alt="image-20210401111845620" style="zoom:50%;" />

- **A类：**第`1`位固定为`0`，**网络号不能全`0`,也不能全`1`，网络范围使`1~126`**
- **B类：前2位固定`10`，无限制，网络号范围使`128.0~191.255`**
- **C类：前3位固定`110`，无限制，网络号范围`192.0.0~223.255.255`**
- **D类：多播地址，范围`224.0.0.0~239.255.255`** 

<img src="https://s2.loli.net/2022/03/29/hrtWKbXFQyp4uzL.png" alt="image-20210401122431550" style="zoom:50%;" />

<img src="https://s2.loli.net/2022/03/29/eXt4vl9SQwshcpW.png" alt="image-20210401122739887" style="zoom:50%;" />

#### 划分子网的IPV4地址

> 对一个网络号进行分网络管理，**节约地址，避免过多的申请网络号来管理网络**

**如何实现？**

> 通过借用主机号的比特来作为子网号

- 子网掩码**使用连续的比特 1 来对应网络号和子网号；使用连续的比特 0 来表示主机号**
- 将`ipv4`地址和子网掩码进行逻辑与运算就可以得到子网地址

#### 无分类编制的IPv4地址

> **数量巨大的C类网因为其他地址空间太小并没有得到充分使用，同时IPv4急剧消耗**
>
> 1993年，IETF发布**无分类域间路由选择CIDR**

- CIDR消除了传统的A类、B类和C类地址，还有子网概念

- **斜线记法**，或称CIDR记法 。斜线后面写上网络前缀所占比特数量

  <img src="https://s2.loli.net/2022/03/29/14Hc2fDPeyAoUSb.png" alt="image-20210402092157889" style="zoom:50%;" />

- **CIDR实际上是将网络前缀相同的连续IP地址组成一个”CIDR地址块“**

**路由聚合**

> **将路由器中的网络共同前缀提取出来成为新的网络号，同时将剩余主机号置0放入路由器B中**
>
> 如：`A`连接了`172.1.4.0/25`和`172.1.7.0/24`，则提取公共前缀聚合后变为**172.1.4.0/22**

## 4. IP数据报发送转发过程 ##

> 同一个网络之间的主机可以直接通信，不同网络之间的主机通信需要路由器中转

**源主机如何判断目的主机是否和自己在同一个网络中？**

> 将自身的`IP`地址与子网掩码**相与**得到自身的网络号`1`，再将目的`IP`地址与自身子网掩码相与得到网络号`2`。若两个网络号相等，则说明处在同一个网络

**主机如何知道应该把IP数据报交给哪个路由器进行转发呢？**

> 通过设置默认网关。所谓默认网关，即当路由表中查不到数据时会将数据发往的路由器端口`IP`地址

#### 静态路由配置 ####

**静态路由配置是指用户或网络管理员使用路由器的相关命令给路由器人工配置路由表**

+ 这种人工配置方式简单、开销小。但不能及时适应网络状态的变化。**一般只在小规模网络中采用**
+ 可能由于：①配置错误 ②聚合了不存在的网络 ③网络故障 而**出现路由环路错误**
+ ==默认路由为：0.0.0.0/0== 。其**作用是当路由表不知道往哪里转发时，就会往默认路由指定的下一跳位置转发**，根据网络号最长匹配原理，默认路由网络号长度为`0`，因此一定是最后一个被匹配的条目
+ ==特定主机路由：具体主机IP/32==。网络号前缀长度`32`保证了这是第一个被匹配的静态条目

**如何防止错误路由导致IP数据报永久兜圈？**

1. 在`IP`数据报首部**设置生存时间TTL字段**
   + `IP`数据报进入路由器后，`TTL`字段的值减`1`。**若TTL的值不等于0，则被路由器转发，否则被丢弃**
2. 对于聚合后或由于网络故障而不存在的路由条目**设置黑洞路由**
   + 所谓**黑洞路由，即路由器应该丢弃的路由**

## 5. 路由选择协议 ##

因特网所采用的的路由选择协议主要特点

+ **自适应**：动态路由选择，能较好地适应网络状态的变化
+ **分布式**：路由器之间交换路由信息
+ **分层次**：将整个因特网划分为许多较小的自治系统`AS`

### 1. 路由选择协议

RIP 使用**跳数**作为度量来衡量到达目的网络的距离

- 到**直连网络**的距离定义为1
- **非直连网络**的距离定义为所经过的路由器数+1
- **“距离”等于16时，相当于不可达**，适用于小型互联网
- **好的路由：**通过数少的路由，不考虑带宽
- 如果**多条”距离相等“**，则负载均衡
- **特点：**
  - 仅与相邻路由器交换信息
  - 交换的是个自路由表的信息
  - 周期性交换信息

<img src="https://s2.loli.net/2022/03/29/LNaVzts4AGpiS1q.png" alt="image-20210402105534964" style="zoom:50%;" />

### 2. RIP 存在问题

> "坏消息传播很慢"：又称**路由环路（两个路由器相互学习错误路由，造成循环**），直到计数到无穷的时候，才会结束

- 限制最大路径距离为15（16表示不可到达）
- 路由表发生变化，立即更新报文，而不是周期性发送
- 记录**接收**到特定路由信息的接口，而不让路由信息通过此接口**发送**（**水平分割，毒性反转**）

### 3. 开放最短路径优先OSPF

> 得到一个带权有向图，以当前路由器为起点，通过迪杰斯特拉算法得到到达某个点的最短路径

- OSPF 是**基于链路状态的**，而不像 RIP 那样是基于距离向量的

- 不限制网络规模，更新效率高，收敛速度快

- **链路状态**是指本路由器和哪些路由器相邻，以及相应链路的“代价”、

  - “代价”包括**费用、距离、时延、带宽**

- OSPF 通过发送**问候（Hello）分组**，维护邻居关系

  - 周期10秒、超过40秒认为不可达

  <img src="https://s2.loli.net/2022/03/29/c9CxFbqiNLU847a.png" alt="image-20210402194552098" style="zoom:50%;" />

- 每个路由器都会产生**链路状态通告LSA**

  - 直连网络状态信息
  - 邻居路由器状态信息

- LSA 被封装在**链路状态更新分组LSU中，采用泛洪发送**

- LSA被存储在**链路状态数据库LSDB，通过泛洪发送封装LSA的LSU分组**

- **基于LSDB进行最短路径优先SPF计算**，构建出到各个点的最短路径表

**OSPF五种分组**

1. **问候（Hello）分组**

   用来发现和维护邻居路由器的可达性

2. **数据库描述（Database Desription）分组**

   向邻居路由器给出自己的链路状态数据库中的所有链路状态项目的摘要信息

3. **链路状态请求信息（Link State Request）分组**

   向邻居路由器请求发送某些链路状态项目的详细信息

4. **链路状态更新（Link State Update）分组**

   将其链路状态进行泛红发送，即用泛红法对全网 更新链路状态

5. **链路状态确认（Link State Acknowledgment）分组**

   对链路状态更新分组的确认分组

**OSPF基本工作过程**

1. **周期性发送问候分组（Hello）**，维护邻居关系
2. 向邻居路由器**发送数据库描述分组（DD）**，将自己链路状态数据库中的所有链路状态项目的摘要信息发送给邻居路由器
3. 如果缺少某些链路状态项目，会发送**链路状态请求分组（LSR）**
4. 收到请求分组后，发送**链路状态更新分组（LSU）**
5. 收到更新分组后，将这些信息添加到自己的链路状态数据库中

**邻居关系建立**

> 每个路由器都要向其他路由器发送问候分组和链路状态更新分组。为了减少发送分组数量，设置了指定路由器和备用路由器

OSPF 采用选举**指定路由器DR（Designated Router）和备用指定路由器BDR（Backup Designated Router）**来减少邻居数目

**规则：**

- 所有的非DR/BDR只与DR/BDR建立邻居关系
- 非DR/BDR之间通过 DR/BDR交换信息
- DR失效时又BDR顶上

## 边界网关协议BGP

> 尽力寻找一条能够达到目的网路且比较好的路由（不兜圈子），而不是找到最佳路由

<img src="https://s2.loli.net/2022/03/29/6n1GYkZI3sNfDTq.png" alt="image-20210402204919385" style="zoom:50%;" />

**内部网关协议IGP（如路由信息协议RIP或最短路径优先OSPF）**

- 一个自治系统内尽可能有效地从源网络传输到目的网络
- 无需考虑自治系统外部其他方面的策略

**外部网关协议EGP（边界网关协议BGP）**

- 在不同自治系统内，度量路由的：”代价“（距离、宽带、费用）可能不同。因此选择“代价”作为度量来寻找最佳路由是不行的
- 还有**经济、政治、安全**的因素，比如中国的数据报要尽量绕开美国的自治系统

### 1. 工作原理

<img src="https://s2.loli.net/2022/03/29/ncI7vqrRfYjJLhW.png" alt="image-20210402210541270" style="zoom:50%;" />

- BGP 发言人**交换网络可达性的信息**（到达其他网络所要经过的一系列自治系统）
- 各个BGP 发言人会**找出到达各自自治系统的较好路由**。也就是构造出树形结构（防环路）自治系统连通图

### 2. BGP-4中的4报文

1. **OPEN（打开）报文：**与相邻的另一个BGP发言人建立关系，使通信初始化
2. **UPDATE（更新）报文：**用来通告某一路由的信息，以及列出要撤销的多条路由
3. **KEEPALIVE（保活）报文：**用来周期性地证实临战的连通性
4. **NOTIFICATION（通知）报文：**用来发送检测到的差错

<img src="https://s2.loli.net/2022/03/29/ojSbrpkuUflyxmP.png" alt="image-20210402212051046" style="zoom: 33%;" />

## 6. IPV4数据报首部格式

<img src="https://s2.loli.net/2022/03/29/l2HxjfOtw6VJkGM.png" alt="image-20210403102328289" style="zoom:50%;" />

1. **版本**

   占4比特，表示协议版本，通信双方使用的IP协议版本必须一致。目前广泛使用的IP协议版本号为4（IPv4）

2. **首部长度**

   占4比特，表示IP数据报首部长度。以**4字节为单位**

   **最小十进制为5**，表示IP数据报首部只有20字节（**4字节为单位，所以对应20字节**）

   **最大十进制为15，表示IP数据报包含20字节固定和最大40字节可变部分**

3. **可选字段**
   
   > 长度从1到40个字节不等。用来支持排错、测量及安全等措施。实际上很少被使用
   
4. **填充字段**

   确保首部长度为4字节长度的整数倍，使用全0进行填充

5. **区分服务**

   占8比特，利用该字段的不同数值可提供不同等级的服务质量，只有在使用区分服务时，该字段才起作用。一般情况下不使用该字段

6. **总长度**

   占16比特，表示IP数据报的总长度【首部+数据载荷】，最大取值为65335，以字节为单位

7. **标识**

   占16比特，属于同一个数据报的各分片数据报应该具有相同的标识

8. **标志**

   占3比特：

   1. DF：1，0表示是否允许分片
   2. MF：1，0表示是否还有分片
   3. 保留位：必须为零

9. **片偏移（必须是整数）**

   占13比特，指出分片数据报的数据载荷部分偏移其在原数据报的位置有多杀单位

   **以8个字节为单位**

   <img src="https://s2.loli.net/2022/03/29/v3EcitHnKlSbeZj.png" alt="image-20210403105053561" style="zoom:50%;" />

10. **生存时间**

   占8比特，最初以秒为单位，最大生存周期为255秒；路由器转发IP数据报时，将IP数据报首部中的该字段减去IP数据报在本路由器耗费的时间，若不为0，则转发

​    

   **现在以“跳数”为单位，路由器转发IP数据报时，将IP数据报首部中的该字段值减1，若不为0就转发，否则丢弃【防止 兜圈】**

11. **协议**

    占8比特，指明IPv4数据报的数据部分是何种协议数据单元

    <img src="https://s2.loli.net/2022/03/29/CbSUJTO7Ap6ri3Z.png" alt="image-20210403110400976" style="zoom:50%;" />

12. **首部检验和**

    占16比特，用来检测首部在传输过程中是否出现差错，称为因特网检验和

    IP数据报每经过一个路由器就要重新计算首部检验和，因为某些字段的取值可能发生变化

    因为不可靠传输，所以在IPv6中不再计算首部检验和，从而更快转发IP数据报

13. **源IP地址和目的IP地址**

    各占32比特，用来填写发送该IP数据报的源主机IP地址和接收该IP数据报的目的主机

## 7. 网际层控制报文

> 为了提高转发效率和成功率，网际层使用了网际层控制报文协议ICMP

- 主机或路由器使用ICMP来发送差错报告报文和询问报文
- ICMP报文被封装在IP数据报中发送

### 1. 回答报文类型4种

1. **终点不可达**

   > 当路由器或主机**不能交付数据报**时，就向源点发送终点不可达报文

2. **源点抑制**

   > 当路由器或主机**由于拥塞而丢弃数据报**时，就向源点发送抑制报文，使源点发送速率放慢

3. **时间超过**

   > 当路由器收到一个目的IP地址不是自己的IP地址数据报，会将其**生存时间TTL字段减1**。若结果不为0，则转发；反之丢弃，并发送时间超过报文

4. **参数问题**

   > 当路由器或主机收到IP数据报后，**发现了误码**，则丢弃该数据报，并发送参数问题报文

5. **改变路由（重定向）**

   > 路由器把改变路由报文发送给主机，让主机知道下次应该将数据报发送给另外的路由器（**该系统认为更好的路由器**）

### 2. 询问报文类型

**回送请求和回答**

> 用来测试目的站是否可达及其相关状态

- ICMP回送请求是由主机或路由器向一个特定的目的主机发出的询问
- 收到报文的必须给源主机或路由器发送ICMP回送回答报文

**时间戳请求和回答**

> 用来进行时钟同步和测量时间

- 请求某个主机或路由器回答当前的日期和时间
- 回答由32比特构成，代表从1900年1月1日到现在一共多少秒

**不能发送ICMP的情况**

1. 对ICMP差错报文不再发送ICMP差错报文
2. 只**对第一个分片差错**的进行发送差错报文
3. 对**多播地址的数据报**都不发送ICMP差错报告报文
4. **特殊地址（127.0.0.0或0.0.0.0）**的数据报不发送ICMP差错报告报文

### ICMP应用举例

1. **分组网间探测PING**

   - 用来测试主机或路由器间的连通性【eNSP的ping命令】
   - 应用层直接使用网际层的ICMP（没有通过运输层的TCP或UDP）
   - 使用ICMP回送请求和回答报文

2. **跟踪路由tracerouce**

   > 用来测试IP数据报从源主机到达目的主机要经过哪些路由器

   **windows**

   - tacert命令
   - 应用层直接使用网际层ICMP
   - 使用了ICMP回送请求和回答报文以及差错报文

   **实现**

   > 主机发送出去的数据包中的生存时间字段TTL由1开始逐渐增加，通过返回的报文可以知道是哪个路由器

## 8.虚拟专用网VPN

<img src="https://s2.loli.net/2022/03/29/xlqVQjNHWF8GP4i.png" alt="image-20210403132652875" style="zoom:50%;" />

> 利用公用因特网作为本机构各专用网之间的通信载体，这样的专用网又称为虚拟专用网
>
> 虚拟专用网中各主机所分配的地址应该是本机构可自由分配的专用地址

<img src="https://s2.loli.net/2022/03/29/dAlX2KpP5c7OUiQ.png" alt="image-20210403132227798" style="zoom: 50%;" />

## 9.网络地址转换NAT

> 使大量内部专用地址的**专用网络用户共享少量外部全球地址**来访问因特网上的主机和资源【节省IPv4地址】

因为大多数应用使用运输层协议TCP或UDP来传送数据，因此可以利用**运输层的端口号和IP地址一起进行转换**

这样，用一个全球IP地址就可以使多个拥有本地地址的主机同时和因特网上的主机进行通信，这种端口号和IP地址一起进行转换的技术叫做**网络地址与端口号转换NAPT**

